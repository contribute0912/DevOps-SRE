
name: AI Security Scan (GitHub Models)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [ "main" ]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to analyze"
        required: true
        type: string

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read

jobs:
  ai-security:
    runs-on: ubuntu-latest

    steps:
      - name: Sanity step
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref:   ${{ github.ref }}"
          echo "SHA:   ${{ github.sha }}"
          echo "Input PR: ${{ inputs.pr_number }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Determine the PR number for both event types
      - name: Resolve PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "number=${{ inputs.pr_number }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Capture PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            > "$RUNNER_TEMP/pr.diff"

      - name: Collect brief repo context
        run: |
          {
            echo "# Repo overview"
            git ls-files | sed 's/^/- /' | head -n 300
            echo ""
            echo "# Key config files (partial)"
            for f in package.json requirements.txt pyproject.toml pom.xml build.gradle Dockerfile *.tf; do
              [ -f "$f" ] && { echo "## $f"; head -n 150 "$f"; echo ""; }
            done
          } > "$RUNNER_TEMP/repo_context.txt"

      - name: AI security review via GitHub Models
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SYS_PROMPT=$(cat << 'EOF'
You are a senior application security engineer. Review ONLY the provided Git diff.
Return a concise vulnerability report:
- Summary table: {title, severity [Critical/High/Medium/Low], file:line, category (CWE/OWASP if applicable), confidence}
- For each item: short reasoning, minimal snippet (no secrets), exploitability, and precise fix suggestion (diff or code).
- Ignore style/perf nitpicks. If none found, write: "No material security risks observed in diff."
Focus areas: injection, XSS, CSRF, authN/Z, SSRF, path traversal, unsafe deserialization, insecure crypto, secrets exposure, logging leaks, error handling, insecure defaults, RCE, DoS, privilege escalation, dependency misuse.
EOF
)

          USER_PROMPT=$(printf "Analyze the PR diff for security vulnerabilities.\n\n## Repo context (partial)\n%s\n\n## Git diff\n%s" \
            "$(head -c 30000 "$RUNNER_TEMP/repo_context.txt")" \
            "$(head -c 180000 "$RUNNER_TEMP/pr.diff")")

          PAYLOAD=$(jq -n \
            --arg model "openai/gpt-4.1-mini" \
            --arg sys "$SYS_PROMPT" \
            --arg user "$USER_PROMPT" \
            '{
              model: $model,
              messages: [
                { "role": "system", "content": $sys },
                { "role": "user",   "content": $user }
              ]
            }')

          RESPONSE=$(curl -sSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "${PAYLOAD}")

          COMPLETION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')

          if [ -z "$COMPLETION" ]; then
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf ":warning: AI security review returned no content.\n\n\`\`\`json\n%s\n\`\`\`\n" "$RESPONSE" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          else
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf "%s\n" "$COMPLETION" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR with AI security review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY_FILE="$RUNNER_TEMP/ai_security_review.md"
          printf "%s\n" "${{ steps.ai.outputs.completion }}" > "$BODY_FILE"
          gh pr comment ${{ steps.pr.outputs.number }} \
            --repo "${{ github.repository }}" \
            --body-file "$BODY_FILE"
