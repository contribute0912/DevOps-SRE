name: PR Vulnerability Scan

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main"]             # adjust if target branch differs
  workflow_dispatch:               # manual trigger

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read                     # for GitHub Models (AI summary)
  # security-events: write         # uncomment if you later upload SARIF to code scanning

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      # Always runs, so workflow_dispatch shows a run even without a PR
      - name: Sanity step (runs on all events)
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref:   ${{ github.ref }}"
          echo "SHA:   ${{ github.sha }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Capture the PR diff for traceability (similar to your AI review workflow)
      - name: Get PR diff to file
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            > "$RUNNER_TEMP/pr.diff"

      # --- SCA (dependencies & OS) with Trivy ---
      # Trivy scans filesystem (repo) for vulnerable dependencies across supported ecosystems
      - name: Trivy filesystem scan (JSON)
        uses: aquasecurity/trivy-action@v0.22.0
        with:
          scan-type: fs
          format: json
          output: ${{ runner.temp }}/trivy.json
          ignore-unfixed: true               # configurable
          severity: CRITICAL,HIGH,MEDIUM,LOW # configurable

      # --- SAST with Semgrep (security rules) ---
      # Semgrep runs lightweight static analysis. Using p/ci for broad coverage.
      - name: Semgrep SAST scan (JSON)
        uses: returntocorp/semgrep-action@v1
        with:
          config: p/ci
          json: ${{ runner.temp }}/semgrep.json
        env:
          SEMGREP_APP_TOKEN: ""   # not required for OSS rule packs (p/ci)

      # Build a human-readable summary markdown from Trivy + Semgrep output
      - name: Summarize findings (Markdown)
        run: |
          TRIVY_JSON="$RUNNER_TEMP/trivy.json"
          SEMGREP_JSON="$RUNNER_TEMP/semgrep.json"
          OUT="$RUNNER_TEMP/vuln_summary.md"

          echo "## ðŸ” PR Vulnerability Scan Summary" > "$OUT"
          echo "" >> "$OUT"

          echo "### Trivy (SCA / dependencies)" >> "$OUT"
          echo "" >> "$OUT"
          for sev in CRITICAL HIGH MEDIUM LOW UNKNOWN; do
            count=$(jq "[.Results[]? | .Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" "$TRIVY_JSON")
            printf "- **%s**: %s\n" "$sev" "$count" >> "$OUT"
          done
          echo "" >> "$OUT"
          echo "**Top HIGH/CRITICAL findings:**" >> "$OUT"
          jq -r '.Results[]? | .Vulnerabilities[]? |
                 select(.Severity=="CRITICAL" or .Severity=="HIGH") |
                 "- [" + .Severity + "] " + (.PkgName // "unknown") + "@" + (.InstalledVersion // "unknown") +
                 " â€” " + (.Title // "No title") +
                 " (CVE: " + (.VulnerabilityID // "N/A") + ") | Fixed: " + ((.FixedVersion // "N/A")) +
                 " | File: " + ((.Target // "N/A"))' \
            "$TRIVY_JSON" | head -n 20 >> "$OUT"
          echo "" >> "$OUT"

          echo "### Semgrep (SAST)" >> "$OUT"
          echo "" >> "$OUT"
          SEM_ERR=$(jq '[.results[]? | select(.severity=="ERROR")] | length' "$SEMGREP_JSON")
          SEM_WARN=$(jq '[.results[]? | select(.severity=="WARNING")] | length' "$SEMGREP_JSON")
          SEM_INFO=$(jq '[.results[]? | select(.severity=="INFO")] | length' "$SEMGREP_JSON")
          echo "- **ERROR**: $SEM_ERR" >> "$OUT"
          echo "- **WARNING**: $SEM_WARN" >> "$OUT"
          echo "- **INFO**: $SEM_INFO" >> "$OUT"
          echo "" >> "$OUT"
          echo "**Top ERROR/WARNING findings:**" >> "$OUT"
          jq -r '.results[]? |
                 select(.severity=="ERROR" or .severity=="WARNING") |
                 "- [" + (.severity) + "] " + (.check_id // "rule") + " â€” " + (.extra.message // "No message") +
                 " | " + (.path // "unknown") + ":" + ((.start.line | tostring) // "0")' \
            "$SEMGREP_JSON" | head -n 20 >> "$OUT"

      # Optional: AI security summary using GitHub Models (mirrors your AI review approach)
      - name: AI security summary via GitHub Models (curl)
        if: ${{ github.event_name == 'pull_request' }}
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TRIVY_JSON="$RUNNER_TEMP/trivy.json"
          SEMGREP_JSON="$RUNNER_TEMP/semgrep.json"
          PRDIFF_FILE="$RUNNER_TEMP/pr.diff"

          # Build prompt: keep it concise but actionable
          SYS_PROMPT="You are a strict, helpful Application Security reviewer. Summarize vulnerabilities found by Trivy (SCA) and Semgrep (SAST) for the given PR. Prioritize HIGH/CRITICAL (Trivy) and ERROR/WARNING (Semgrep). Provide concise, actionable remediation steps. Reference files and components when possible."

          USER_TEXT=$(printf "PR: %s\n\nPR Diff (snippet):\n%s\n\nTrivy JSON:\n%s\n\nSemgrep JSON:\n%s\n" \
            "${{ github.event.pull_request.html_url }}" \
            "$(head -n 400 "$PRDIFF_FILE" 2>/dev/null || true)" \
            "$(head -c 200000 "$TRIVY_JSON")" \
            "$(head -c 200000 "$SEMGREP_JSON")")

          PAYLOAD=$(jq -n \
            --arg model "openai/gpt-4.1-mini" \
            --arg sys "$SYS_PROMPT" \
            --arg user "$USER_TEXT" \
            '{
              model: $model,
              messages: [
                {"role": "system", "content": $sys},
                {"role": "user",   "content": $user}
              ]
            }')

          RESPONSE=$(curl -sSL -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "${PAYLOAD}")

          COMPLETION=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          if [ -z "$COMPLETION" ]; then
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf ":warning: AI summary returned no content.\n\n\`\`\`json\n%s\n\`\`\`\n" "$RESPONSE" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          else
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf "%s\n" "$COMPLETION" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          fi

      # Comment on PR with the combined summary (machine + AI)
      - name: Comment on PR with vulnerability scan results
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BODY_FILE="$RUNNER_TEMP/vuln_comment.md"

          {
            echo "## ðŸ” Automated PR Vulnerability Scan"
            echo ""
            cat "$RUNNER_TEMP/vuln_summary.md"
            echo ""
            echo "---"
            echo "### ðŸ¤– AI Security Summary"
            echo ""
            printf "%s\n" "${{ steps.ai.outputs.completion }}"
          } > "$BODY_FILE"

          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            --body-file "$BODY_FILE"

      # Fail the job on severe findings (configurable)
      - name: Fail on HIGH/CRITICAL (Trivy) or ERROR/WARNING (Semgrep)
        run: |
          TRIVY_JSON="$RUNNER_TEMP/trivy.json"
          SEMGREP_JSON="$RUNNER_TEMP/semgrep.json"

          TRIVY_HC=$(jq '[.Results[]? | .Vulnerabilities[]? | select(.Severity=="CRITICAL" or .Severity=="HIGH")] | length' "$TRIVY_JSON")
          SEMGREP_HW=$(jq '[.results[]? | select(.severity=="ERROR" or .severity=="WARNING")] | length' "$SEMGREP_JSON")

          echo "Trivy HIGH/CRITICAL count: $TRIVY_HC"
          echo "Semgrep ERROR/WARNING count: $SEMGREP_HW"

          if [ "$TRIVY_HC" -gt 0 ] || [ "$SEMGREP_HW" -gt 0 ]; then
            echo "::error::High/Critical (Trivy) or Error/Warning (Semgrep) findings present. Failing the job."
            exit 1
          fi
