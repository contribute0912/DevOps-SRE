name: PR Vulnerability Scan

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read
  # security-events: write

jobs:
  scan:
    runs-on: ubuntu-latest

    steps:
      - name: Sanity step (runs on all events)
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref:   ${{ github.ref }}"
          echo "SHA:   ${{ github.sha }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Capture PR diff for the AI summary and traceability
      - name: Get PR diff to file
        if: ${{ github.event_name == 'pull_request' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            > "$RUNNER_TEMP/pr.diff"

      # --- SCA via Trivy CLI (setup + run) ---
      - name: Setup Trivy
        uses: aquasecurity/setup-trivy@v0.2.4

      - name: Trivy filesystem scan (JSON)
        run: |
          trivy fs \
            --format json \
            --output "$RUNNER_TEMP/trivy.json" \
            --ignore-unfixed \
            --severity CRITICAL,HIGH,MEDIUM,LOW \
            .

      # --- SAST with Semgrep (full scan, non-blocking) ---
      # IMPORTANT: write to the workspace, NOT $RUNNER_TEMP (host path not present inside container).
      - name: Semgrep SAST scan (JSON)
        uses: docker://returntocorp/semgrep:latest
        with:
          args: >
            semgrep scan --config p/ci --json --output ./semgrep.json
        env:
          SEMGREP_ENABLE_METRICS: "off"

      # Quick sanity check so we can see outputs exist before summarizing
      - name: List outputs for debugging
        run: |
          echo "Workspace files:"
          ls -lah "$GITHUB_WORKSPACE" || true
          echo "Runner temp files:"
          ls -lah "$RUNNER_TEMP" || true

      # Summarize findings (Markdown)
      - name: Summarize findings (Markdown)
        run: |
          TRIVY_JSON="$RUNNER_TEMP/trivy.json"
          SEMGREP_JSON="$GITHUB_WORKSPACE/semgrep.json"   # <-- read from workspace
          OUT="$RUNNER_TEMP/vuln_summary.md"

          echo "## ðŸ” PR Vulnerability Scan Summary" > "$OUT"
          echo "" >> "$OUT"

          echo "### Trivy (SCA / dependencies)" >> "$OUT"
          echo "" >> "$OUT"
          for sev in CRITICAL HIGH MEDIUM LOW UNKNOWN; do
            count=$(jq "[.Results[]? | .Vulnerabilities[]? | select(.Severity==\"$sev\")] | length" "$TRIVY_JSON")
            printf -- "- **%s**: %s\n" "$sev" "$count" >> "$OUT"
          done
          echo "" >> "$OUT"
          echo "**Top HIGH/CRITICAL findings:**" >> "$OUT"
          jq -r '.Results[]? | .Vulnerabilities[]? |
                 select(.Severity=="CRITICAL" or .Severity=="HIGH") |
                 "- [" + .Severity + "] " + (.PkgName // "unknown") + "@" + (.InstalledVersion // "unknown") +
                 " â€” " + (.Title // "No title") +
                 " (CVE: " + (.VulnerabilityID // "N/A") + ") | Fixed: " + ((.FixedVersion // "N/A")) +
                 " | File: " + ((.Target // "N/A"))' \
            "$TRIVY_JSON" | head -n 20 >> "$OUT"
          echo "" >> "$OUT"

          echo "### Semgrep (SAST)" >> "$OUT"
          echo "" >> "$OUT"
          SEM_ERR=$(jq '[.results[]? | select(.severity=="ERROR")] | length' "$SEMGREP_JSON")
          SEM_WARN=$(jq '[.results[]? | select(.severity=="WARNING")] | length' "$SEMGREP_JSON")
          SEM_INFO=$(jq '[.results[]? | select(.severity=="INFO")] | length' "$SEMGREP_JSON")
          printf -- "- **ERROR**: %s\n" "$SEM_ERR" >> "$OUT"
          printf -- "- **WARNING**: %s\n" "$SEM_WARN" >> "$OUT"
          printf -- "- **INFO**: %s\n" "$SEM_INFO" >> "$OUT"
          echo "" >> "$OUT"
          echo "**Top ERROR/WARNING findings:**" >> "$OUT"
          jq -r '.results[]? |
                 select(.severity=="ERROR" or .severity=="WARNING") |
                 "- [" + (.severity) + "] " + (.check_id // "rule") + " â€” " + (.extra.message // "No message") +
                 " | " + (.path // "unknown") + ":" + ((.start.line | tostring) // "0")' \
            "$SEMGREP_JSON" | head -n 20 >> "$OUT"

      # Optional: AI security summary using GitHub Models
      - name: AI security summary via GitHub Models (curl)
        if: ${{ github.event_name == 'pull_request' }}
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TRIVY_JSON="$RUNNER_TEMP/trivy.json"
          SEMGREP_JSON="$GITHUB_WORKSPACE/semgrep.json"
          PRDIFF_FILE="$RUNNER_TEMP/pr.diff"

          SYS_PROMPT="You are a strict, helpful Application Security reviewer. Summarize vulnerabilities found by Trivy (SCA) and Semgrep (SAST) for the given PR. Prioritize HIGH/CRITICAL (Trivy) and ERROR/WARNING (Semgrep). Provide concise, actionable remediation steps. Reference files and components when possible."

          USER_TEXT=$(printf "PR: %s\n\nPR Diff (snippet):\n%s\n\nTrivy JSON:\n%s\n\nSemgrep JSON:\n%s\n" \
            "${{ github.event.pull_request.html_url }}" \
