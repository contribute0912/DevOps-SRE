
name: AI PR Security Review (Simplified)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: ["main"]   # adjust if needed
  workflow_dispatch:     # manual trigger
    inputs:
      pr_number:
        description: "PR number to review (optional)"
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write
  models: read

env:
  MODEL_ID: openai/gpt-4.1-mini
  MAX_DIFF_BYTES: "80000"
  MAX_FILES_BYTES: "80000"

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Sanity check
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Repo:  ${{ github.repository }}"
          echo "PR #:  ${{ github.event.pull_request.number || inputs.pr_number || 'n/a' }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install jq and gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          gh --version || (curl -fsSL https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | sudo bash)

      - name: Resolve SHAs
        id: sha
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "base_sha=${{ github.event.pull_request.base.sha }}" >> $GITHUB_OUTPUT
            echo "head_sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
            echo "pr_num=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            PR="${{ inputs.pr_number }}"
            if [ -n "$PR" ]; then
              DATA=$(gh api repos/${{ github.repository }}/pulls/$PR)
              echo "base_sha=$(echo $DATA | jq -r '.base.sha')" >> $GITHUB_OUTPUT
              echo "head_sha=$(echo $DATA | jq -r '.head.sha')" >> $GITHUB_OUTPUT
              echo "pr_num=$PR" >> $GITHUB_OUTPUT
              git fetch origin
            else
              echo "base_sha=$(git rev-parse HEAD~1)" >> $GITHUB_OUTPUT
              echo "head_sha=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
              echo "pr_num=" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Collect diff and files
        run: |
          BASE=${{ steps.sha.outputs.base_sha }}
          HEAD=${{ steps.sha.outputs.head_sha }}
          git diff --unified=0 $BASE $HEAD > $RUNNER_TEMP/pr.diff || true
          CHANGED=$(git diff --name-only $BASE $HEAD)
          : > $RUNNER_TEMP/files_sample.txt
          for f in $CHANGED; do
            case "$f" in
              *.py|*.js|*.ts|*.java|*.go|*.rb|*.php|*.c|*.cpp)
                [ -f "$f" ] && echo -e "\n===== FILE: $f =====\n" >> $RUNNER_TEMP/files_sample.txt && head -c 16384 "$f" >> $RUNNER_TEMP/files_sample.txt
              ;;
            esac
          done

      - name: Build prompts
        run: |
          cat > $RUNNER_TEMP/system_prompt.txt <<'SYS'
You are a senior application security engineer. Review the PR diff and snippets.
Return Markdown with:
- Summary
- High-risk findings
- Medium/Low findings
- Suggested fixes
- References
SYS
          jq -n \
            --arg repo "${{ github.repository }}" \
            --arg pr "${{ steps.sha.outputs.pr_num }}" \
            --rawfile diff "$RUNNER_TEMP/pr.diff" \
            --rawfile files "$RUNNER_TEMP/files_sample.txt" \
            '{repo:$repo, pr_number:$pr, diff:$diff, files:$files}' > $RUNNER_TEMP/user_payload.json

      - name: Call GitHub Models
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          SYS=$(cat $RUNNER_TEMP/system_prompt.txt)
          USER=$(cat $RUNNER_TEMP/user_payload.json)
          PAYLOAD=$(jq -n --arg model "$MODEL_ID" --arg sys "$SYS" --arg user "$USER" \
            '{model:$model,messages:[{"role":"system","content":$sys},{"role":"user","content":$user}],temperature:0.2}')
          RESPONSE=$(curl -sSL -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "$PAYLOAD")
          echo "$RESPONSE" | jq -r '.choices[0].message.content // "No content"' > $RUNNER_TEMP/ai_review.md

      - name: Comment on PR
        if: ${{ steps.sha.outputs.pr_num != '' }}
        run: gh pr comment ${{ steps.sha.outputs.pr_num }} --repo "${{ github.repository }}" --body-file "$RUNNER_TEMP/ai_review.md"

      - name: Upload artifact
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/upload-artifact@v4
        with:
          name: ai-security-review
          path: ${{ runner.temp }}/ai_review.md
