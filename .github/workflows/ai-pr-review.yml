name: AI PR Review (GitHub Models)

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: read
  pull-requests: write
  issues: write
  models: read   # Required to access GitHub Models from Actions

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install jq (JSON parser)
        run: sudo apt-get update && sudo apt-get install -y jq

      # Write the PR diff to a temp file (avoid outputs for large/messy content)
      - name: Get PR diff to file
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            > "$RUNNER_TEMP/pr.diff"

      - name: AI code review via GitHub Models (curl)
        id: ai
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Read diff safely (may contain quotes, ${{
          # ... }}, YAML, etc.)
          USER_TEXT=$(printf "Review the following Git diffs:\n%s" "$(cat "$RUNNER_TEMP/pr.diff")")

          # Build JSON payload for GitHub Models chat completions
          # Docs: https://docs.github.com/en/github-models/quickstart
          PAYLOAD=$(jq -n \
            --arg model "openai/gpt-4.1-mini" \
            --arg sys "You are a strict, helpful code reviewer. Provide a concise, actionable review focusing on security, performance, readability, and small fixes." \
            --arg user "$USER_TEXT" \
            '{
              model: $model,
              messages: [
                { "role": "system", "content": $sys },
                { "role": "user",   "content": $user }
              ]
            }')

          # Call GitHub Models chat completions endpoint
          RESPONSE=$(curl -sSL \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "${PAYLOAD}")

          # Extract assistant message; remain robust if schema changes
          COMPLETION=$(echo "$RESPONSE" | jq -r '
            .choices[0].message.content
            // .choices[0].delta.content
            // empty
          ')

          # Expose completion to next step; use a unique delimiter to avoid collisions
          if [ -z "$COMPLETION" ]; then
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf ":warning: AI review returned no content.\n\nResponse:\n\`\`\`json\n%s\n\`\`\`\n" "$RESPONSE" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          else
            echo "completion<<AI_EOF" >> "$GITHUB_OUTPUT"
            printf "%s\n" "$COMPLETION" >> "$GITHUB_OUTPUT"
            echo "AI_EOF" >> "$GITHUB_OUTPUT"
          fi

      - name: Comment on PR with AI review
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --repo "${{ github.repository }}" \
            --body "${{ steps.ai.outputs.completion }}"
