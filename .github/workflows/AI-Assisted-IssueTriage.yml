
name: Simple AI Issue Triage

on:
  issues:
    types: [opened, edited, reopened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

env:
  MODEL_ID: "openai/gpt-4.1-mini"

  # --- Label maps (edit to match your repo) ---
  SEVERITY_LABELS_JSON: |
    { "critical": "severity:critical", "high": "severity:high", "medium": "severity:medium", "low": "severity:low" }
  PRIORITY_LABELS_JSON: |
    { "P0": "priority:P0", "P1": "priority:P1", "P2": "priority:P2", "P3": "priority:P3" }
  TEAM_LABELS_JSON: |
    { "frontend": "team:frontend", "backend": "team:backend", "platform": "team:platform", "infra": "team:infra", "security": "team:security", "docs": "team:docs" }

  # --- Optional: priority-based response templates ---
  PRIORITY_RESPONSE_TEMPLATES_JSON: |
    {
      "P0": "Marked as P0. The on-call is investigating immediately; update within 2 hours.",
      "P1": "Marked as P1. We'll share a triage plan within 1 business day.",
      "P2": "Marked as P2. Weâ€™ll review in the next sprint planning.",
      "P3": "Marked as P3. Added to backlog; we'll revisit when capacity allows."
    }

jobs:
  triage:
    runs-on: ubuntu-latest

    steps:
      - name: Install jq and gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq
          gh --version || (type -p curl >/dev/null || sudo apt-get install -y curl && \
            curl -fsSL https://raw.githubusercontent.com/cli/cli/trunk/script/install.sh | sudo bash)

      - name: Build prompt
        run: |
          cat > prompt.json <<'JSON'
          {
            "task": "Classify this issue and return STRICT JSON only.",
            "schema": {
              "category": ["bug","feature","docs","question","chore","security","performance","other"],
              "severity": ["critical","high","medium","low","null"],
              "priority": ["P0","P1","P2","P3","null"],
              "team": ["frontend","backend","platform","infra","security","docs","null"],
              "labels": "array of short strings"
            },
            "rules": [
              "If not clearly stated, set severity/priority/team to null.",
              "Keep labels concise (0-3)."
            ],
            "issue": {
              "title": "${{ github.event.issue.title }}",
              "body": "${{ github.event.issue.body }}"
            }
          }
          JSON

      - name: Call GitHub Model
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PAYLOAD=$(jq -n \
            --arg model "$MODEL_ID" \
            --arg sys 'You are a precise issue triager. Output STRICT JSON only with keys: category, severity, priority, team, labels.' \
            --arg user "$(cat prompt.json)" \
            '{model:$model, messages:[{"role":"system","content":$sys},{"role":"user","content":$user}], temperature:0.2}')

          RESPONSE=$(curl -sS -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${GITHUB_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            -H "Content-Type: application/json" \
            https://models.github.ai/inference/chat/completions \
            -d "$PAYLOAD")

          CONTENT=$(echo "$RESPONSE" | jq -r '.choices[0].message.content // empty')
          [ -z "$CONTENT" ] && CONTENT='{"category":"other","severity":"null","priority":"null","team":"null","labels":[]}'
          printf "%s" "$CONTENT" > triage_raw.txt

          # Extract JSON between first '{' and last '}' (in case of prose)
          sed -n '1h;1!H;${;g;s/^[^{]*{/{/;s/}[^}]*$/}/;p;}' triage_raw.txt > triage_maybe.json || true
          if jq -e . triage_maybe.json >/dev/null 2>&1; then
            jq '.' triage_maybe.json > triage.json
          else
            echo '{"category":"other","severity":"null","priority":"null","team":"null","labels":[]}' > triage.json
          fi

      - name: Compute labels (category + severity + priority + team)
        id: labels
        env:
          SEVERITY_LABELS_JSON: ${{ env.SEVERITY_LABELS_JSON }}
          PRIORITY_LABELS_JSON: ${{ env.PRIORITY_LABELS_JSON }}
          TEAM_LABELS_JSON: ${{ env.TEAM_LABELS_JSON }}
        run: |
          CATEGORY=$(jq -r '.category // empty' triage.json)
          SEV_KEY=$(jq -r '.severity // empty' triage.json)
          PRI_KEY=$(jq -r '.priority // empty' triage.json)
          TEAM_KEY=$(jq -r '.team // empty' triage.json)

          jq -r '.labels[]? // empty' triage.json > labels.tmp || true
          [ -n "$CATEGORY" ] && [ "$CATEGORY" != "null" ] && echo "$CATEGORY" >> labels.tmp

          SEV_LABEL=$(jq -r --arg k "$SEV_KEY" '.[$k] // empty' <<< "$SEVERITY_LABELS_JSON")
          PRI_LABEL=$(jq -r --arg k "$PRI_KEY" '.[$k] // empty' <<< "$PRIORITY_LABELS_JSON")
          TEAM_LABEL=$(jq -r --arg k "$TEAM_KEY" '.[$k] // empty' <<< "$TEAM_LABELS_JSON")

          [ -n "$SEV_LABEL" ] && echo "$SEV_LABEL" >> labels.tmp
          [ -n "$PRI_LABEL" ] && echo "$PRI_LABEL" >> labels.tmp
          [ -n "$TEAM_LABEL" ] && echo "$TEAM_LABEL" >> labels.tmp

          (cat labels.tmp 2>/dev/null || true) | awk 'NF' | sort -u > final_labels.txt

          echo "labels<<EOF" >> $GITHUB_OUTPUT
          cat final_labels.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "priority=$PRI_KEY" >> $GITHUB_OUTPUT

      - name: Ensure labels exist
        if: ${{ steps.labels.outputs.labels != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          while IFS= read -r lbl; do
            [ -z "$lbl" ] && continue
            gh api --silent --method POST \
              -H "Accept: application/vnd.github+json" \
              /repos/${{ github.repository }}/labels \
              -f name="$lbl" \
              -f color="BFD4F2" \
              -f description="Auto-created by triage workflow" || true
          done < final_labels.txt

      - name: Apply labels (single gh call, no checkout)
        if: ${{ steps.labels.outputs.labels != '' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # gh CLI uses GH_TOKEN
        run: |
          if [ ! -s final_labels.txt ]; then
            echo "No labels to apply."
            exit 0
          fi
          LABELS=$(paste -sd, final_labels.txt)
          echo "Applying labels: $LABELS to issue #${{ github.event.issue.number }} in ${{ github.repository }}"
          gh issue edit ${{ github.event.issue.number }} \
            --add-label "$LABELS" \
            --repo "${{ github.repository }}"

      - name: Post priority response (optional)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PRIORITY_RESPONSE_TEMPLATES_JSON: ${{ env.PRIORITY_RESPONSE_TEMPLATES_JSON }}
        run: |
          PRI="${{ steps.labels.outputs.priority }}"
          RESP=$(jq -r --arg k "$PRI" '.[$k] // empty' <<< "$PRIORITY_RESPONSE_TEMPLATES_JSON")
          [ -z "$RESP" ] && RESP="Thanks! Weâ€™ve recorded this and will update with progress."

          CAT=$(jq -r '.category // "other"' triage.json)
          SEV=$(jq -r '.severity // "n/a"' triage.json)
          PRI_VAL=$(jq -r '.priority // "n/a"' triage.json)
          TEAM=$(jq -r '.team // "n/a"' triage.json)

          {
            echo "### ðŸ¤– Auto-triage summary"
            echo "- **Category:** \`$CAT\`"
            echo "- **Severity:** \`$SEV\`"
            echo "- **Priority:** \`$PRI_VAL\`"
            echo "- **Team:** \`$TEAM\`"
            echo
            echo "$RESP"
            echo
            echo "_Posted by Simple AI Triage (Model: $MODEL_ID)._"
          } > comment.md

          gh issue comment ${{ github.event.issue.number }} --body-file comment.md --repo "${{ github.repository }}"
